# ============================================================================
# PROMETHEUS CONFIGURATION
# ============================================================================
# Documentation: https://prometheus.io/docs/prometheus/latest/configuration/configuration/
# ============================================================================

global:
  scrape_interval: 15s          # Intervalle de scrape par defaut
  evaluation_interval: 15s      # Intervalle d'evaluation des rules
  scrape_timeout: 10s           # Timeout par defaut

  # Labels attaches a toutes les metriques
  external_labels:
    cluster: 'observability-cluster'
    environment: 'production'

# ----------------------------------------------------------------------------
# ALERTMANAGER CONFIGURATION
# ----------------------------------------------------------------------------
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - alertmanager:9093
      scheme: http
      timeout: 10s

# ----------------------------------------------------------------------------
# RULES FILES
# ----------------------------------------------------------------------------
rule_files:
  - /etc/prometheus/rules/recording_rules.yml
  - /etc/prometheus/rules/alert_rules.yml
  - /etc/prometheus/rules/kafka_recording_rules.yml
  - /etc/prometheus/rules/kafka_alert_rules.yml
  - /etc/prometheus/rules/logstash_recording_rules.yml
  - /etc/prometheus/rules/logstash_alert_rules.yml

# ----------------------------------------------------------------------------
# SCRAPE CONFIGURATIONS
# ----------------------------------------------------------------------------
scrape_configs:

  # ==========================================================================
  # PROMETHEUS SELF-MONITORING
  # ==========================================================================
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
    metrics_path: /metrics

  # ==========================================================================
  # ALERTMANAGER METRICS
  # ==========================================================================
  - job_name: 'alertmanager'
    static_configs:
      - targets: ['alertmanager:9093']
    metrics_path: /metrics

  # ==========================================================================
  # ELASTICSEARCH EXPORTER
  # ==========================================================================
  - job_name: 'elasticsearch'
    static_configs:
      - targets: ['elasticsearch-exporter:9114']
        labels:
          cluster: 'observability-cluster'
    scrape_interval: 15s
    scrape_timeout: 10s
    metrics_path: /metrics

  # ==========================================================================
  # BLACKBOX EXPORTER - ELASTICSEARCH HTTP PROBES
  # ==========================================================================
  - job_name: 'blackbox-elasticsearch'
    metrics_path: /probe
    params:
      module: [http_2xx_skip_tls]
    static_configs:
      - targets:
          - https://es01:9200/_cluster/health
          - https://es02:9200/_cluster/health
          - https://es03:9200/_cluster/health
        labels:
          probe_type: 'elasticsearch'
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter:9115
      - source_labels: [__param_target]
        regex: 'https://([^:]+):.*'
        replacement: '$1'
        target_label: node

  # ==========================================================================
  # BLACKBOX EXPORTER - KIBANA HTTP PROBES
  # ==========================================================================
  - job_name: 'blackbox-kibana'
    metrics_path: /probe
    params:
      module: [http_2xx]
    static_configs:
      - targets:
          - http://kibana:5601/api/status
        labels:
          probe_type: 'kibana'
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter:9115

  # ==========================================================================
  # BLACKBOX EXPORTER - GRAFANA HTTP PROBES
  # ==========================================================================
  - job_name: 'blackbox-grafana'
    metrics_path: /probe
    params:
      module: [http_2xx]
    static_configs:
      - targets:
          - http://grafana:3000/api/health
        labels:
          probe_type: 'grafana'
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter:9115

  # ==========================================================================
  # BLACKBOX EXPORTER - TCP PROBES (ES Transport)
  # ==========================================================================
  - job_name: 'blackbox-tcp'
    metrics_path: /probe
    params:
      module: [tcp_connect]
    static_configs:
      - targets:
          - es01:9300
          - es02:9300
          - es03:9300
        labels:
          probe_type: 'elasticsearch-transport'
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter:9115
      - source_labels: [__param_target]
        regex: '([^:]+):.*'
        replacement: '$1'
        target_label: node

  # ==========================================================================
  # OPENTELEMETRY COLLECTOR METRICS
  # ==========================================================================
  - job_name: 'otel-collector'
    static_configs:
      - targets: ['otel-collector:8888']
    scrape_interval: 15s
    metrics_path: /metrics

  # ==========================================================================
  # GRAFANA METRICS
  # ==========================================================================
  - job_name: 'grafana'
    static_configs:
      - targets: ['grafana:3000']
    metrics_path: /metrics

  # ==========================================================================
  # KAFKA JMX METRICS (via JMX Exporter)
  # ==========================================================================
  - job_name: 'kafka-jmx'
    static_configs:
      - targets:
          - kafka01:7071
          - kafka02:7071
          - kafka03:7071
        labels:
          cluster: 'kafka-cluster'
    scrape_interval: 15s
    scrape_timeout: 10s
    metrics_path: /metrics
    relabel_configs:
      - source_labels: [__address__]
        regex: '([^:]+):.*'
        replacement: '$1'
        target_label: broker

  # ==========================================================================
  # KAFKA EXPORTER METRICS (Consumer Lag, Topics, Partitions)
  # ==========================================================================
  - job_name: 'kafka-exporter'
    static_configs:
      - targets: ['kafka-exporter:9308']
        labels:
          cluster: 'kafka-cluster'
    scrape_interval: 15s
    scrape_timeout: 10s
    metrics_path: /metrics

  # ==========================================================================
  # LOGSTASH METRICS
  # ==========================================================================
  - job_name: 'logstash'
    static_configs:
      - targets: ['logstash:9600']
        labels:
          pipeline: 'main'
    scrape_interval: 15s
    scrape_timeout: 10s
    metrics_path: /_node/stats

  # ==========================================================================
  # BLACKBOX EXPORTER - KAFKA PROBES
  # ==========================================================================
  - job_name: 'blackbox-kafka'
    metrics_path: /probe
    params:
      module: [tcp_connect]
    static_configs:
      - targets:
          - kafka01:9092
          - kafka02:9092
          - kafka03:9092
        labels:
          probe_type: 'kafka'
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter:9115
      - source_labels: [__param_target]
        regex: '([^:]+):.*'
        replacement: '$1'
        target_label: broker

  # ==========================================================================
  # BLACKBOX EXPORTER - ZOOKEEPER PROBES
  # ==========================================================================
  - job_name: 'blackbox-zookeeper'
    metrics_path: /probe
    params:
      module: [tcp_connect]
    static_configs:
      - targets:
          - zookeeper:2181
        labels:
          probe_type: 'zookeeper'
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter:9115

  # ==========================================================================
  # BLACKBOX EXPORTER - LOGSTASH PROBES
  # ==========================================================================
  - job_name: 'blackbox-logstash'
    metrics_path: /probe
    params:
      module: [http_2xx]
    static_configs:
      - targets:
          - http://logstash:9600
        labels:
          probe_type: 'logstash'
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter:9115
