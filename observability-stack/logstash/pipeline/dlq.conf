# ============================================================================
# LOGSTASH DEAD LETTER QUEUE PIPELINE
# ============================================================================
# Pipeline: DLQ -> Processing -> Elasticsearch (failed-events index)
# ============================================================================

input {
  # ==========================================================================
  # DEAD LETTER QUEUE INPUT
  # ==========================================================================
  dead_letter_queue {
    path => "/usr/share/logstash/data/dead_letter_queue"
    commit_offsets => true
    pipeline_id => "main"
  }
}

filter {
  # ==========================================================================
  # PRESERVE ORIGINAL EVENT INFO
  # ==========================================================================
  mutate {
    add_field => {
      "[dlq][reason]" => "%{[@metadata][dead_letter_queue][reason]}"
      "[dlq][plugin_type]" => "%{[@metadata][dead_letter_queue][plugin_type]}"
      "[dlq][plugin_id]" => "%{[@metadata][dead_letter_queue][plugin_id]}"
      "[dlq][entry_time]" => "%{[@metadata][dead_letter_queue][entry_time]}"
    }
  }

  # Add processing timestamp
  ruby {
    code => "event.set('[dlq][processed_at]', Time.now.utc.iso8601(3))"
  }
}

output {
  # ==========================================================================
  # ELASTICSEARCH OUTPUT - Failed Events Index
  # ==========================================================================
  elasticsearch {
    # Use only es01 and es02 as primary hosts
    hosts => ["https://es01:9200", "https://es02:9200"]
    user => "${ES_USER:elastic}"
    password => "${ES_PASSWORD:changeme}"
    ssl_enabled => true
    ssl_certificate_authorities => ["/usr/share/logstash/config/certs/ca/ca.crt"]
    ssl_verification_mode => "none"

    # Separate index for failed events
    index => "failed-events-%{+YYYY.MM.dd}"

    # No ILM for failed events (manual review)
    ilm_enabled => false

    # Sniffing disabled to prevent discovery of unhealthy nodes
    sniffing => false
  }

  # ==========================================================================
  # DEBUG OUTPUT
  # ==========================================================================
  # stdout {
  #   codec => rubydebug
  # }
}
